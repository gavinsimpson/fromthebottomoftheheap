  <!DOCTYPE html>
<html lang="en">
  <head prefix="dc: http://purl.org/dc/terms/ og: http://ogp.me/ns# :cc http://creativecommons.org/ns#">
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-7900310-7"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-7900310-7');
</script>


    <meta charset="utf-8">
    <title>Two new versions of gratia released</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Gavin Simpson">
    
    
<!-- HTML5 metadata -->

<meta name="keywords" content="gratia, GAMs, CRAN, releases" />


<meta name="description" content="While the Covid-19 pandemic and teaching a new course in the fall put paid to most of my development time last year, some time off work this January allowed me time to work on gratia ðŸ“¦ again. I released 0.5.0 to CRAN in part to fix an issue with tests not running on the new M1 chips from Apple because I wasnâ€™t using vdiffr ðŸ“¦ conditionally. Version 0.5.1 followed shortly thereafter as Iâ€™d messed up an argument name in smooth_estimates(), a new function that I hope will allow development to proceed more quickly and mke it easier to maintain code and extend functionality to cover a greater range of model types. Read on to fin out more about smooth_estimates() and what else was in these two releases.
" />

<!-- RDFa Metadata (in DublinCore) -->
<meta property="dc:title" content="Two new versions of gratia released" />
<meta property="dc:creator" content="Gavin Simpson" />

<meta property="dc:date" content="2021-01-30T15:00:00-06:00" />

<meta property="dc:type" content="" /> <!-- article? entry?-->
<meta property="dc:format" content="text/html" />
<meta property="dc:language" content="en" />
<meta property="dc:source" content="From the Bottom of the Heap" />
<!-- RDFa Metadata (in OpenGraph) -->
<meta property="og:title" content="Two new versions of gratia released" />
<meta property="og:author" content="https://www.fromthebottomoftheheap.net/about/" />
<meta property="http://ogp.me/ns/profile#first_name" content="Gavin"/>
<meta property="http://ogp.me/ns/profile#last_name" content="Simpson"/>

<meta property="http://ogp.me/ns/article#published_time" content="2021-01-30T15:00:00-06:00" />

<meta property="og:site_name" content="From the Bottom of the Heap" />
<meta property="og:url" content="https://www.fromthebottomoftheheap.net/2021/01/30/two-new-versions-of-gratia-on-cran/" />
<meta property="og:type" content="article" />

<meta name="og:description" content="While the Covid-19 pandemic and teaching a new course in the fall put paid to most of my development time last year, some time off work this January allowed me time to work on gratia ðŸ“¦ again. I released 0.5.0 to CRAN in part to fix an issue with tests..." />

<!-- Twitter Card Meta data -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site.id" content="@ucfagls" />
<meta name="twitter:creator:id" content="@ucfagls" />
<meta name="twitter:title" content="Two new versions of gratia released" />

<meta name="twitter:image" content="https://www.fromthebottomoftheheap.net/assets/img/posts/two-new-versions-of-gratia-colour-scales-1.png" />


<meta name="twitter:description" content="While the Covid-19 pandemic and teaching a new course in the fall put paid to most of my development time last year, some time off work this January allowed me time to work on gratia ðŸ“¦ again. I re..." />

<!-- Google Scholar Metadata -->
<meta name="resource_type" content="From the Bottom of the Heap"/>
<meta name="citation_journal_title" content="From the Bottom of the Heap"/>

<meta name="citation_publication_date" content="30 Jan 2021"/>
<meta name="citation_date" content="30 Jan 2021"/>

<meta name="citation_author" content="Gavin Simpson"/>
<meta name="citation_title" content="Two new versions of gratia released"/>

    
    <!-- Link to the Atom feeds -->
    <link href="https://www.fromthebottomoftheheap.net/feed.xml" type="application/atom+xml" rel="alternate" title="From the bottom of the heap ATOM feed">
    <link href="https://www.fromthebottomoftheheap.net/feed-R.xml" type="application/atom+xml" rel="alternate" title="From the bottom of the heap ATOM feed of R posts">
    
    <!-- Le styles -->
    <link href="https://www.fromthebottomoftheheap.net/assets/css/bootstrap.css" rel="stylesheet">
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }
    </style>
    <link href="https://www.fromthebottomoftheheap.net/assets/css/pyg_monokai.css" rel="stylesheet">
    <link href="https://www.fromthebottomoftheheap.net/assets/css/ftboth.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="https://www.fromthebottomoftheheap.net/assets/ico/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://www.fromthebottomoftheheap.net/assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://www.fromthebottomoftheheap.net/assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://www.fromthebottomoftheheap.net/assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="https://www.fromthebottomoftheheap.net/assets/ico/apple-touch-icon-57-precomposed.png">
    
    <script data-ad-client="ca-pub-2908943772231164" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  </head>

  <body>

      <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="https://www.fromthebottomoftheheap.net">From the bottom of the heap</a>
          <div class="nav-collapse collapse">
            <ul class="nav">
              <li ><a href="https://www.fromthebottomoftheheap.net"><i class="icon-home"></i> Home</a></li>
              <li ><a href="https://www.fromthebottomoftheheap.net/about/"><i class="icon-info-sign"></i> About</a></li>
              <li class="active"><a href="https://www.fromthebottomoftheheap.net/blog/"><i class="icon-comment"></i> Blog</a></li>
              <li ><a href="https://www.fromthebottomoftheheap.net/publications/"><i class="icon-file"></i> Publications</a></li>
              <li ><a href="https://www.fromthebottomoftheheap.net/research/"><i class="icon-wrench"></i> Research</a></li>
              <li  class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                  <i class="icon-filter"></i> The Lab <b class="caret"></b>
                </a>
                <ul class="dropdown-menu">
                  <li><a tabindex="-1" href="https://www.fromthebottomoftheheap.net/lab/">About</a></li>
                  <li><a tabindex="-1" href="https://www.fromthebottomoftheheap.net/lab/research/">Research</a></li>
                  <li><a tabindex="-1" href="https://www.fromthebottomoftheheap.net/lab/members/">Members</a></li>
                  <li><a tabindex="-1" href="https://www.fromthebottomoftheheap.net/lab/publications">Publications</a></li>
                  <li><a tabindex="-1" href="https://www.fromthebottomoftheheap.net/lab/join/">Join the lab</a></li>
                </ul>
              </li>
              <li ><a href="https://www.fromthebottomoftheheap.net/teaching/"><i class="icon-user"></i> Teaching</a></li>
              <li  class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown"><i class="icon-hdd"></i> Code <b class="caret"></b></a>
                <ul class="dropdown-menu">
                  <li class="dropdown-submenu">
                    <a tabindex="-1" href="https://www.fromthebottomoftheheap.net/code/dper-scripts/">DPER Scripts</a>
                    <ul class="dropdown-menu">
                      <li>
                        <a tabindex="-1" href="https://www.fromthebottomoftheheap.net/code/dper-scripts/chapter-9-statistical-learning/">Chapter 9</a>
                      </li>
                      <li>
                        <a tabindex="-1" href="https://www.fromthebottomoftheheap.net/code/dper-scripts/chapter-15-analogue-methods/">Chapter 15</a>
                      </li>
                      <li>
                        <a tabindex="-1" href="https://www.fromthebottomoftheheap.net/code/dper-scripts/chapter-19-human-impacts/">Chapter 19</a>
                      </li>
                    </ul>
                  </li>
                  <li class="dropdown-submenu">
                    <a tabindex="-1" href="https://www.fromthebottomoftheheap.net/code/r-packages">R Packages</a>
                    <ul class="dropdown-menu">
                      <li>
                        <a tabindex="-1" href="https://www.fromthebottomoftheheap.net/code/r-packages/analogue/">analogue</a>
                      </li>
                      <li>
                        <a tabindex="-1" href="https://www.fromthebottomoftheheap.net/code/r-packages/permute/">permute</a>
                      </li>
                      <li>
                        <a tabindex="-1" href="https://www.fromthebottomoftheheap.net/code/r-packages/vegan/">vegan</a>
                      </li>
                      <li>
                        <a tabindex="-1" href="https://www.fromthebottomoftheheap.net/code/r-packages/gratia/">gratia</a>
                      </li>
                      <li>
                        <a tabindex="-1" href="https://www.fromthebottomoftheheap.net/code/r-packages/cocorresp/">cocorresp</a>
                      </li>
                      <li>
                        <a tabindex="-1" href="https://www.fromthebottomoftheheap.net/code/r-packages/coenocliner/">coenocliner</a>
                      </li>
                      <li>
                        <a tabindex="-1" href="https://www.fromthebottomoftheheap.net/code/r-packages/temporalEF/">temporalEF</a>
                      </li>
                      <li>
                        <a tabindex="-1" href="https://www.fromthebottomoftheheap.net/code/r-packages/canadaHCD/">canadaHCD</a>
                      </li>
                      <li>
                        <a tabindex="-1" href="https://www.fromthebottomoftheheap.net/code/r-packages/ggvegan/">ggvegan</a>
                      </li>
                      <li>
                        <a tabindex="-1" href="https://www.fromthebottomoftheheap.net/code/r-packages/pcurve/">pcurve</a>
                      </li>
                    </ul>
                  </li>
                </ul>
              </li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>


    <div class="container">
          

      <article>
      <div class="row">
        <!-- <div class="span8 offset2"> -->
        <div class="span10">
          <div class="clearfix">
            <span class="post-nav"><i class="icon-arrow-left"></i> <a href="https://www.fromthebottomoftheheap.net/2021/01/31/getting-data-from-canada-covid-19-tracker-using-r/">Getting data from the Canada Covid-19 Tracker using R</a></span>
            <span class="post-nav" style="float: right;"><a href="https://www.fromthebottomoftheheap.net/2020/06/03/extrapolating-with-gams/">Extrapolating with B splines and GAMs</a> <i class="icon-arrow-right"></i></span>
          </div>
          <div class="page-header">
            <header>
              <h1>Two new versions of gratia released </h1>
            </header>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="span12">
          <div class="row">
            <div class="span10">
              
            <p>While the Covid-19 pandemic and teaching a new course in the fall put paid to most of my development time last year, some time off work this January allowed me time to work on <strong>gratia</strong> ðŸ“¦ again. I released 0.5.0 to CRAN in part to fix an issue with tests not running on the new M1 chips from Apple because I wasnâ€™t using <strong>vdiffr</strong> ðŸ“¦ conditionally. Version 0.5.1 followed shortly thereafter as Iâ€™d messed up an argument name in <code>smooth_estimates()</code>, a new function that I hope will allow development to proceed more quickly and mke it easier to maintain code and extend functionality to cover a greater range of model types. Read on to fin out more about <code>smooth_estimates()</code> and what else was in these two releases.</p>
<h2 id="evaluating-smooths-with-smooth_estimates">Evaluating smooths with <code>smooth_estimates()</code></h2>
<p>For a while now Iâ€™ve realised that the way Iâ€™d implemented <code>evaluate_smooth()</code> wasnâ€™t great. Some design decisions I took earlier on added a lot of unnecessary complexity to the function through handling of factor <code>by</code> smooths, and which didnâ€™t really work properly in the context of a GAM where the same variable could be in multiple smooth terms.</p>
<p>My original plan was to use a facetted plot for factor <code>by</code> variable smooths, and so when you selected a model term (more on that later), if that term was a factor <code>by</code> smooth, instead of just pulling in a single smooth, I would pull in all of the smooths associated with the factor <code>by</code>. Handling this got complicated and resulted in some kludgy, messy code that was prone to failure when used with a more specialised smooth or a more complex model.</p>
<p>Additionally, how I initially implemented selection of model terms was a bit silly; a user could pass a string for a variable that would be matched against the labels that <strong>mgcv</strong> ðŸ“¦ uses for smooth. Any instance of the term in any smooth would then get selected, which is not usually what is wanted when working with complex models with multiple smooths, some of which might contin the same variable.</p>
<p>Because of this, in the summer I decided to completely rewrite <code>evaluate_smooth()</code>. Then I realised this would not be a good idea as I was going to break a lot of existing code, including code weâ€™d written in support of papers that had been published and which used <code>evaluate_smooth()</code>. Instead, I decided to start from a clean slate with a new function that didnâ€™t do any of the silly things Iâ€™d messed up <code>evaluate_smooth()</code> with, and which would be much simpler to maintain and develop for a wider range of complex distributional models.</p>
<p>In writing <code>smooth_estimates()</code> I also came up with a standard way to represent all evaluations of a smooth, regardless of type. The nice thing about this is that itâ€™s easy to return a tibble containing all the values of the evaluated smooth for many smooths at once, something you couldnâ€™t do with <code>evaluate_smooth()</code>.</p>
<p>The idea behind <code>evaluate_smooth()</code> and <code>smooth_estimates()</code> is to return a tibble of values of the smooth evaluated at a grid of <code>n</code> points over each of the covariates involved in that smooth.</p>
<figure class="highlight">
<pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="s1">'mgcv'</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="s1">'gratia'</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="s1">'dplyr'</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="s1">'tidyr'</span><span class="p">)</span><span class="w">

</span><span class="n">dat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data_sim</span><span class="p">(</span><span class="s2">"eg1"</span><span class="p">,</span><span class="w"> </span><span class="n">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">42</span><span class="p">)</span><span class="w">
</span><span class="n">gam_model</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gam</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">s</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">s</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="w"> </span><span class="n">bs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"cr"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">s</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span><span class="w"> </span><span class="n">bs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"bs"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">s</span><span class="p">(</span><span class="n">x3</span><span class="p">,</span><span class="w"> </span><span class="n">bs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ps"</span><span class="p">),</span><span class="w">
                 </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dat</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"REML"</span><span class="p">)</span><span class="w">

</span><span class="n">smooth_estimates</span><span class="p">(</span><span class="n">gam_model</span><span class="p">)</span></code></pre>
</figure>
<figure class="highlight">
<pre><code class="language-text" data-lang="text"># A tibble: 400 x 9
   smooth type  by       est    se       x0    x1    x2    x3
   &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1 s(x0)  TPRS  NA    -1.34  0.392 0.000239    NA    NA    NA
 2 s(x0)  TPRS  NA    -1.26  0.366 0.0103      NA    NA    NA
 3 s(x0)  TPRS  NA    -1.19  0.342 0.0204      NA    NA    NA
 4 s(x0)  TPRS  NA    -1.11  0.319 0.0304      NA    NA    NA
 5 s(x0)  TPRS  NA    -1.03  0.298 0.0405      NA    NA    NA
 6 s(x0)  TPRS  NA    -0.956 0.280 0.0506      NA    NA    NA
 7 s(x0)  TPRS  NA    -0.881 0.264 0.0606      NA    NA    NA
 8 s(x0)  TPRS  NA    -0.806 0.250 0.0707      NA    NA    NA
 9 s(x0)  TPRS  NA    -0.733 0.238 0.0807      NA    NA    NA
10 s(x0)  TPRS  NA    -0.661 0.229 0.0908      NA    NA    NA
# â€¦ with 390 more rows</code></pre>
</figure>
<p>This seems a little wasteful â€” all those <code>NA</code> columns ðŸ˜± â€” but the output is a consistent wa to represent smooths, regardless of the number of covariates etc.</p>
<p>Iâ€™m toying with returning the tibble in a nested fashion with <code>nest()</code>, something like</p>
<figure class="highlight">
<pre><code class="language-r" data-lang="r"><span class="n">sm</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">smooth_estimates</span><span class="p">(</span><span class="n">gam_model</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">nest</span><span class="p">(</span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">est</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="p">),</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">starts_with</span><span class="p">(</span><span class="s1">'x'</span><span class="p">))</span><span class="w">
</span><span class="n">sm</span></code></pre>
</figure>
<figure class="highlight">
<pre><code class="language-text" data-lang="text"># A tibble: 4 x 5
  smooth type     by    values             data              
  &lt;chr&gt;  &lt;chr&gt;    &lt;chr&gt; &lt;list&gt;             &lt;list&gt;            
1 s(x0)  TPRS     NA    &lt;tibble [100 Ã— 2]&gt; &lt;tibble [100 Ã— 4]&gt;
2 s(x1)  CRS      NA    &lt;tibble [100 Ã— 2]&gt; &lt;tibble [100 Ã— 4]&gt;
3 s(x2)  B spline NA    &lt;tibble [100 Ã— 2]&gt; &lt;tibble [100 Ã— 4]&gt;
4 s(x3)  P spline NA    &lt;tibble [100 Ã— 2]&gt; &lt;tibble [100 Ã— 4]&gt;</code></pre>
</figure>
<p>which I think is much neater, but does require extra steps from the user to just use the output</p>
<figure class="highlight">
<pre><code class="language-r" data-lang="r"><span class="n">sm</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">unnest</span><span class="p">(</span><span class="n">cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">))</span><span class="w"> </span></code></pre>
</figure>
<figure class="highlight">
<pre><code class="language-text" data-lang="text"># A tibble: 400 x 9
   smooth type  by       est    se       x0    x1    x2    x3
   &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1 s(x0)  TPRS  NA    -1.34  0.392 0.000239    NA    NA    NA
 2 s(x0)  TPRS  NA    -1.26  0.366 0.0103      NA    NA    NA
 3 s(x0)  TPRS  NA    -1.19  0.342 0.0204      NA    NA    NA
 4 s(x0)  TPRS  NA    -1.11  0.319 0.0304      NA    NA    NA
 5 s(x0)  TPRS  NA    -1.03  0.298 0.0405      NA    NA    NA
 6 s(x0)  TPRS  NA    -0.956 0.280 0.0506      NA    NA    NA
 7 s(x0)  TPRS  NA    -0.881 0.264 0.0606      NA    NA    NA
 8 s(x0)  TPRS  NA    -0.806 0.250 0.0707      NA    NA    NA
 9 s(x0)  TPRS  NA    -0.733 0.238 0.0807      NA    NA    NA
10 s(x0)  TPRS  NA    -0.661 0.229 0.0908      NA    NA    NA
# â€¦ with 390 more rows</code></pre>
</figure>
<p>Internally, the individual smooths are nested by default as that makes it easy to join the tibbles for multiple smooth together. As such, the <em>un</em>nested-ness of the current behaviour requires an explicit extra step within <code>smooth_estimates()</code>.</p>
<p>If you have thoughts about this, let me know in the comments below.</p>
<p><code>smooth_estimates()</code> is going to supersede <code>evaluate_smooth()</code>, and currently it can handle pretty much everything that <code>evaluate_smooth()</code> can do. That doesnâ€™t mean <code>evaluate_smooth()</code> is going anywhere; as I mentioned above, I donâ€™t want to break old code, so as log as it doesnâ€™t take too much time to maintain <code>evaluate_smooth()</code> isnâ€™t hurting anyone if I put it out to pasture.</p>
<p>Version 0.5.0 introduced <code>smooth_estimates()</code> which could only handle very simple univariate smooths, but version 0.5.1 expanded those capabilities. There are a few special smooths that I havenâ€™t yet added capabilities for, including Markov random field smooths and soap film smooths. Support for those will be added by the time version 0.6.0 hits CRAN later this year.</p>
<h2 id="partial-residuals">Partial residuals</h2>
<p>Version 0.4.0 introduced the ability to add partial residuals to plots of smooths. Version 0.5.0 exposes this functionality for computing partial residuals via new function <code>partial_residuals()</code></p>
<figure class="highlight">
<pre><code class="language-r" data-lang="r"><span class="n">partial_residuals</span><span class="p">(</span><span class="n">gam_model</span><span class="p">)</span></code></pre>
</figure>
<figure class="highlight">
<pre><code class="language-text" data-lang="text"># A tibble: 400 x 4
    `s(x0)` `s(x1)` `s(x2)` `s(x3)`
      &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
 1 -0.236    -1.20   -2.19   0.730 
 2  0.00545   0.640  -1.79   1.10  
 3  1.58      1.66    5.59   1.13  
 4 -1.24     -1.83   -0.892 -0.783 
 5 -2.21     -0.100  -2.71  -3.10  
 6  1.27     -1.20    3.93   0.0835
 7 -0.599     2.94   -0.793 -1.10  
 8  1.59      0.402   7.04   2.09  
 9  2.74      0.449   7.33   2.45  
10  1.11     -0.263   0.730  0.703 
# â€¦ with 390 more rows</code></pre>
</figure>
<p>The names are currently non-standard â€” hence all the backticks â€” and I might change that if I can think of a short hand way to refer to smooths that still allows referencing them uniquely when there are things like factor <code>by</code> smooths involved.</p>
<p>I also added an <code>add_partial_residuals()</code>, to add the partial residuals to an existing data frame</p>
<figure class="highlight">
<pre><code class="language-r" data-lang="r"><span class="n">dat</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">add_partial_residuals</span><span class="p">(</span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gam_model</span><span class="p">)</span></code></pre>
</figure>
<figure class="highlight">
<pre><code class="language-text" data-lang="text"># A tibble: 400 x 14
       y    x0     x1    x2    x3     f    f0    f1     f2    f3  `s(x0)`
   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
 1  2.99 0.915 0.0227 0.909 0.402  1.62 0.529  1.05 0.0397     0 -0.236  
 2  4.70 0.937 0.513  0.900 0.432  3.25 0.393  2.79 0.0630     0  0.00545
 3 13.9  0.286 0.631  0.192 0.664 13.5  1.57   3.53 8.41       0  1.58   
 4  5.71 0.830 0.419  0.532 0.182  6.12 1.02   2.31 2.79       0 -1.24   
 5  7.63 0.642 0.879  0.522 0.838 10.4  1.80   5.80 2.76       0 -2.21   
 6  9.80 0.519 0.108  0.160 0.917 10.4  2.00   1.24 7.18       0  1.27   
 7 10.4  0.737 0.980  0.520 0.798 11.3  1.47   7.10 2.75       0 -0.599  
 8 12.8  0.135 0.265  0.225 0.503 11.4  0.821  1.70 8.90       0  1.59   
 9 13.8  0.657 0.0843 0.282 0.254 11.1  1.76   1.18 8.20       0  2.74   
10  7.51 0.705 0.386  0.504 0.667  6.50 1.60   2.16 2.74       0  1.11   
# â€¦ with 390 more rows, and 3 more variables: `s(x1)` &lt;dbl&gt;, `s(x2)` &lt;dbl&gt;,
#   `s(x3)` &lt;dbl&gt;</code></pre>
</figure>
<p>but since implementing this I am now questioning whether this is a good thing or rather whether the implementation is a good thing; thereâ€™s nothing in the code currently to ensure that the data you provided matches the order of the data used to fit the model â€” <em>caveat emptor</em>!</p>
<h2 id="penalty-matrices">Penalty matrices</h2>
<p>Iâ€™ve been adding functions to <strong>gratia</strong> that will be helpful when teaching GAMs; I added <code>basis()</code> a while back and in the 0.5.1 release I added <code>penalty()</code>, for extracting and tidying penalty matrices of smooths from fitted GAM models.</p>
<figure class="highlight">
<pre><code class="language-r" data-lang="r"><span class="n">penalty</span><span class="p">(</span><span class="n">gam_model</span><span class="p">)</span></code></pre>
</figure>
<figure class="highlight">
<pre><code class="language-text" data-lang="text"># A tibble: 324 x 6
   smooth type  penalty row   col   value
   &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt;
 1 s(x0)  TPRS  s(x0)   f1    f1     9.81
 2 s(x0)  TPRS  s(x0)   f1    f2    -1.45
 3 s(x0)  TPRS  s(x0)   f1    f3    -5.00
 4 s(x0)  TPRS  s(x0)   f1    f4    -1.34
 5 s(x0)  TPRS  s(x0)   f1    f5    -6.24
 6 s(x0)  TPRS  s(x0)   f1    f6     3.90
 7 s(x0)  TPRS  s(x0)   f1    f7    -7.74
 8 s(x0)  TPRS  s(x0)   f1    f8    -1.79
 9 s(x0)  TPRS  s(x0)   f1    f9     0   
10 s(x0)  TPRS  s(x0)   f2    f1    -1.45
# â€¦ with 314 more rows</code></pre>
</figure>
<p>There is a <code>draw()</code> method also, to plot the penalty matrix</p>
<figure class="highlight">
<pre><code class="language-r" data-lang="r"><span class="n">gam_model</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">penalty</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">draw</span><span class="p">()</span></code></pre>
</figure>
<figure>
<img src="https://www.fromthebottomoftheheap.net/assets/img/posts/two-new-versions-of-gratia-draw-penalty-1.png" alt="" /><figcaption>Penalty matrices for smooths from the fitted GAM. Note that in the released version you need to visually flip the y-axis so that diagonal runs top-left to bottom-right to match with how the matrix is actually arranged; this is fixed in the GitHub version.</figcaption>
</figure>
<p>It was pointed out that the way this is plotted is not very intuitive if youâ€™re trying to map the way the penalty matrix is written to whatâ€™s shown in the plot â€” you have to flip the y-axis. This is due to how <code>geom_raster()</code> draws things. I have fixed this, but itâ€™s only fixed in the GitHub version of the package, not a current release version.</p>
<h2 id="colour-scales">Colour scales</h2>
<p><code>draw.gam()</code> and some related <code>draw()</code> methods now allow you to configure the colour scales used to plot GAMs. Available options include <code>discrete_colour</code>, <code>continuous_colour</code>, and <code>continuous_fill</code>, that take a suitable scale allowing you to change the colour scheme used etc:</p>
<figure class="highlight">
<pre><code class="language-r" data-lang="r"><span class="n">dat2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data_sim</span><span class="p">(</span><span class="s2">"eg2"</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1000</span><span class="p">,</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"normal"</span><span class="p">,</span><span class="w"> </span><span class="n">scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w">
</span><span class="n">gam_model2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gam</span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">s</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">40</span><span class="p">),</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dat2</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"REML"</span><span class="p">)</span><span class="w">
</span><span class="n">draw</span><span class="p">(</span><span class="n">gam_model2</span><span class="p">,</span><span class="w"> </span><span class="n">n_contour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w">
     </span><span class="n">continuous_fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ggplot2</span><span class="o">::</span><span class="n">scale_fill_distiller</span><span class="p">(</span><span class="n">palette</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Spectral"</span><span class="p">,</span><span class="w">
                                                     </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"div"</span><span class="p">))</span></code></pre>
</figure>
<figure>
<img src="https://www.fromthebottomoftheheap.net/assets/img/posts/two-new-versions-of-gratia-colour-scales-1.png" alt="" /><figcaption>Changing the fill scale used by <code>draw()</code></figcaption>
</figure>
<h2 id="constant-and-fun"><code>constant</code> and <code>fun</code></h2>
<p><code>draw.gam()</code> can now plot smooths after addition of a constant and transformation via a function. This can be used to put smooths (sort of) on the response scale. For example, in the code below, I add the model intercept to each smooth when plotting</p>
<figure class="highlight">
<pre><code class="language-r" data-lang="r"><span class="n">b0</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">coef</span><span class="p">(</span><span class="n">gam_model</span><span class="p">)[</span><span class="m">1</span><span class="p">]</span><span class="w">
</span><span class="n">draw</span><span class="p">(</span><span class="n">gam_model</span><span class="p">,</span><span class="w"> </span><span class="n">constant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b0</span><span class="p">)</span></code></pre>
</figure>
<figure>
<img src="https://www.fromthebottomoftheheap.net/assets/img/posts/two-new-versions-of-gratia-constant-draw-gam-1.png" alt="" /><figcaption>Plotting smooths, rescaling the y-axis to include the model intercept term in the scale.</figcaption>
</figure>
<p>I plan to add an argument <code>response</code>, which would take a logical to indicate if you wan to plot on the response scale. If <code>response = TRUE</code>, it would override anything passed to <code>constant</code> and <code>fun</code>, such that <code>draw.gam()</code> would just do the right thing, and figure out from the model what constant and inverse link function to use. Watch out for that in 0.6.0.</p>
<h2 id="excluding-or-selecting-terms-to-include-in-model-predictions">Excluding or selecting terms to include in model predictions</h2>
<p><code>predict.gam()</code> allows the user to either exclude or specifically include only selected terms in model predictions. Version 0.5.0 added the same functionality in <code>simulate.gam()</code> and <code>predicted_samples()</code>, by allowing you to pass along an <code>exclude</code> or <code>terms</code> argument to <code>predict.gam()</code> that is used in both of these functions.</p>
<h2 id="summary">Summary</h2>
<p>All in all, these are not major changes to the functionality of <strong>gratia</strong>, but the ground work laid in <code>smooth_estimates()</code> should allow me to address lots of the outstanding bugs related to handling complex model and some complex smooth types, and Iâ€™m pretty excited about that.</p>

            <hr />
            <h3>Comments</h3>
            <div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_shortname = "fromthebottomoftheheap";
  var disqus_url = "https://www.fromthebottomoftheheap.net/2021/01/30/two-new-versions-of-gratia-on-cran/";
  var disqus_title = "Two new versions of gratia released";
  //var disqus_identifier = "/2021/01/30/two-new-versions-of-gratia-on-cran";

  (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


            </div>
            <div class="span2">
                            <div class="side-snippet">
                <h4>By Gavin Simpson</h4>
              
                <h4>30 January 2021</h4>
              
              </div>

                            <div class="side-snippet">
                <h4>Posted in</h4>
                
                <a href="https://www.fromthebottomoftheheap.net/category/r/"><span class="label label-warning">R</span></a><br>
                
              </div>
       

                            <div class="side-snippet">
                <h4>Tagged</h4>
                
                  <a href="https://www.fromthebottomoftheheap.net/tag/gratia/"><span class="label label-inverse">gratia</span></a><br>
                
                  <a href="https://www.fromthebottomoftheheap.net/tag/gams/"><span class="label label-inverse">GAMs</span></a><br>
                
                  <a href="https://www.fromthebottomoftheheap.net/tag/cran/"><span class="label label-inverse">CRAN</span></a><br>
                
                  <a href="https://www.fromthebottomoftheheap.net/tag/releases/"><span class="label label-inverse">releases</span></a><br>
                
              </div>

                          <div class="side-snippet">
              <h4>Social</h4>
              <p><img class="bs-icon addToolTip" data-original-title="Send me an email" data-placement="left" data-animation="true" src="https://www.fromthebottomoftheheap.net/assets/img/glyphicons/glyphicons_419_e-mail.png" /> <a href="mailto:ucfagls@gmail.com">ucfagls@gmail.com</a></p>
              <p><img class="bs-icon addToolTip" data-original-title="My twitter profile" data-placement="left" data-animation="true" src="https://www.fromthebottomoftheheap.net/assets/img/glyphicons/glyphicons_411_twitter.png" /> <a href="https://twitter.com/ucfagls">@ucfagls</a></p>
              <p><img class="bs-icon addToolTip" data-original-title="My github profile" data-placement="left" data-animation="true" src="https://www.fromthebottomoftheheap.net/assets/img/glyphicons/glyphicons_401_github.png" /> <a href="https://github.com/gavinsimpson">gavinsimpson</a></p>
              <p><img class="bs-icon addToolTip" data-original-title="ORCID ID" data-placement="left" data-animation="true" src="https://www.fromthebottomoftheheap.net/assets/img/orcid_24x24.png" /> <a href="https://orcid.org/0000-0002-9084-8413">ORCID iD</a></p>
              <p><img class="bs-icon addToolTip" data-original-title="Impactstory profile" data-placement="left" data-animation="true" src="https://www.fromthebottomoftheheap.net/assets/img/impactstory-symbol.png" /> <a href="https://impactstory.org/u/0000-0002-9084-8413">Impactstory profile</a></p>
              <p><img class="bs-icon addToolTip" data-original-title="Subscribe to the blog via RSS (Atom)" data-placement="left" data-animation="true" src="https://www.fromthebottomoftheheap.net/assets/img/glyphicons/glyphicons_417_rss.png" /> <a href="https://www.fromthebottomoftheheap.net/feed.xml" type="application/atom+xml">Subscribe</a></p>
            </div>

                          <div class="side-snippet">
              <h4>Blogroll</h4>
              <ul class="unstyled">
                <li><i class="icon-bookmark"></i> <a href="http://downwithtime.wordpress.com/">Down With time</a></li>
                <li><i class="icon-bookmark"></i> <a href="http://contemplativemammoth.wordpress.com/">The Contemplative Mammoth</a></li>
                <li><i class="icon-bookmark"></i> <a href="http://dynamicecology.wordpress.com/">Dynamic Ecology</a></li>
                <li><i class="icon-bookmark"></i> <a href="http://jabberwocky.weecology.org/">Jabberwocky Ecology</a></li>
                <li><i class="icon-bookmark"></i> <a href="https://recology.info/">Recology</a></li>
                <li><i class="icon-bookmark"></i> <a href="http://www.r-bloggers.com/">R Bloggers</a></li>
                <li><i class="icon-bookmark"></i> <a href="http://www.ancienteco.com/">Andrew Barr's Ancient Eco</a></li>
                <li><i class="icon-bookmark"></i> <a href="http://methodsblog.wordpress.com/">Methods in Ecology &amp; Evolution</a></li>
                <li><i class="icon-bookmark"></i> <a href="http://quantpalaeo.wordpress.com/">Musings on Quantitative Palaeoecology</a></li>
              </ul>
            </div>

              
            </div>
          </div>
        </div>
      </div>
      </article>

        

    </div><!--/.fixed-container-->
    
    <footer>
      <div class="container">
        <div class="row">
          <div class="span2">
            <h4>Menu</h4>
            <ul class="unstyled">
              <li><a href="https://www.fromthebottomoftheheap.net"><small>Home</small></a></li>
              <li><a href="https://www.fromthebottomoftheheap.net/about/"><small>About</small></a></li>
              <li><a href="https://www.fromthebottomoftheheap.net/publications/"><small>Publications</small></a></li>
              <li><a href="https://www.fromthebottomoftheheap.net/research/"><small>Research</small></a></li>
              <li><a href="https://www.fromthebottomoftheheap.net/lab/"><small>The Lab</small></a></li>
              <li><a href="https://www.fromthebottomoftheheap.net/teaching/"><small>Teaching</small></a></li>
              <li><a href="https://www.fromthebottomoftheheap.net/code/dper-scripts/"><small>DPER Scripts</small></a></li>
              <li><a href="https://www.fromthebottomoftheheap.net/code/r-packages/"><small>R Packages</small></a></li>
            </ul>
          </div>
          <div class="span2">
            <h4>R packages</h4>
            <ul class="unstyled">
              <li><a href="https://www.fromthebottomoftheheap.net/code/r-packages/analogue/"><small>analogue</small></a></li>
              <li><a href="https://www.fromthebottomoftheheap.net/code/r-packages/permute/"><small>permute</small></a></li>
              <li><a href="https://www.fromthebottomoftheheap.net/code/r-packages/vegan/"><small>vegan</small></a></li>
              <li><a href="https://www.fromthebottomoftheheap.net/code/r-packages/gratia/"><small>gratia</small></a></li>
              <li><a href="https://www.fromthebottomoftheheap.net/code/r-packages/cocorresp/"><small>cocorresp</small></a></li>
              <li><a href="https://www.fromthebottomoftheheap.net/code/r-packages/coenocliner/"><small>coenocliner</small></a></li>
              <li><a href="https://www.fromthebottomoftheheap.net/code/r-packages/temporalEF/"><small>temporalEF</small></a></li>
              <li><a href="https://www.fromthebottomoftheheap.net/code/r-packages/canadaHCD/"><small>canadaHCD</small></a></li>
              <li><a href="https://www.fromthebottomoftheheap.net/code/r-packages/ggvegan/"><small>ggvegan</small></a></li>
              <li><a href="https://www.fromthebottomoftheheap.net/code/r-packages/pcurve/"><small>pcurve</small></a></li>
            </ul>        
          </div>
          <div class="span6">
            <h4>Fineprint</h4>
            <p><small>Copyright &copy; 2010&ndash;2021 Gavin Simpson. <a href="https://www.fromthebottomoftheheap.net/permissions/">Some Rights Reserved</a>&nbsp;&nbsp;&nbsp;<a rel="license" href="https://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons Licence" style="border-width:0" src="https://licensebuttons.net/l/by/4.0/80x15.png" /></a></small></p>
            <p><small>Icons by <a href="http://www.glyphicons.com/">Glyphicons</a> used under CC-BY licence</small></p>
          </div>
        </div>
      </div>
    </footer>
    
        <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://www.fromthebottomoftheheap.net/assets/js/jquery.min.js"></script>
    <script src="https://www.fromthebottomoftheheap.net/assets/js/bootstrap.js"></script>
    <!--<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>-->
    <script type="text/javascript" async
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>
    <script>
        jQuery(function ($) {
            $(".addToolTip").tooltip()
        });
    </script>
    
    


  </body>
</html>


